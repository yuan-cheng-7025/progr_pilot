{{ extends 'global/Page.html' }}
{{ block title }}Explore your options{{ endblock }}

{{ block content }}

{% load otree %}

{{ formfields }}

<p>This is the <strong>exploration phase</strong>. You can freely sample decks to learn how they work. Your choices in this phase will <strong>not</strong> affect your final performance.</p>

{% if player.time_pressure %}
<p><strong>Time elapsed:</strong> <span id="timer">0</span> seconds</p>
<p><strong>Penalty:</strong> <span id="penalty">0</span> points</p>
<p><strong>Cumulative Payoff:</strong> <span id="cum_payoff">3000</span> points</p>
{% else %}
<p><strong>Cumulative Payoff:</strong> <span id="cum_payoff">3000</span> points</p>
{% endif %}

{% if player.competition %}
<div id="scoreboard" style="margin-top: 1rem;">
    <h5>üèÜ Group Scoreboard</h5>
    <ul id="scoreboard-list"></ul>
</div>
{% endif %}

<div class="container">
    <table class="table">
        <tr><td>Last card reward</td><th id="reward" style="color: green"></th></tr>
        <tr><td>Last card cost</td><th id="cost" style="color: red"></th></tr>
    </table>

    <div class="row">
        {% for letter in 'ABCD' %}
        <div class="col">
            <button type="button" onclick="selectDeck(this)" value="{{ letter }}" class="btn-card">
                <div class="card" style="width: 10rem; height: 14rem">
                    <div class="card-body">
                        <h2 class="card-title">Deck</h2>
                        <h1 class="card-title">{{ letter }}</h1>
                    </div>
                </div>
            </button>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    let buttons = document.getElementsByClassName('btn-card');
    let msgCost = document.getElementById('cost');
    let msgReward = document.getElementById('reward');
    let cumPayoffDisplay = document.getElementById('cum_payoff');
    {% if player.time_pressure %}
    let timerDisplay = document.getElementById('timer');
    let penaltyDisplay = document.getElementById('penalty');
    let startTime = Date.now();
    let timerInterval = setInterval(() => {
        timerDisplay.textContent = Math.floor((Date.now() - startTime) / 1000);
        liveSend({});
    }, 1000);
    {% endif %}

    function selectDeck(btn) {
        liveSend({ letter: btn.value });
        for (let b of buttons) b.disabled = true;
    }

    function liveRecv(data) {
        if (data.finished) {
            {% if player.time_pressure %} clearInterval(timerInterval); {% endif %}
            document.getElementById('form').submit();
            return;
        }
        if (data.reward !== undefined) {
            msgReward.innerHTML = cu(data.reward);
            msgCost.innerHTML = data.cost === 0 ? '' : cu(data.cost);
        }
        if (data.penalty !== undefined) penaltyDisplay.textContent = data.penalty;
        if (data.cum_payoff !== undefined) cumPayoffDisplay.textContent = data.cum_payoff;
        if (data.phase_switched) {
            {% if player.time_pressure %} clearInterval(timerInterval); {% endif %}
            document.getElementById('form').submit();
            return;
        }
        {% if player.competition %}
        if (data.scoreboard) updateScoreboard(data.scoreboard);
        {% endif %}
        for (let b of buttons) b.disabled = false;
    }

    function cu(amount) { return `${amount} points`; }

    function updateScoreboard(list) {
        const ul = document.getElementById('scoreboard-list');
        ul.innerHTML = '';
        list.forEach((entry, i) => {
            const li = document.createElement('li');
            li.textContent = `#${i + 1}: ${entry.name} ‚Äî ${entry.cum_payoff} points`;
            ul.appendChild(li);
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        liveSend({});
    });

    document.addEventListener("keydown", function (event) {
        if (event.code === "Space") {
            {% if player.time_pressure %} clearInterval(timerInterval); {% endif %}
            liveSend({ end_exploration: true });
            return;
        }
        const map = { 'KeyS': 'A', 'KeyF': 'B', 'KeyJ': 'C', 'KeyL': 'D' };
        const letter = map[event.code];
        if (letter) {
            liveSend({ letter: letter });
            for (let b of buttons) b.disabled = true;
            for (let b of buttons) if (b.value === letter) {
                b.style.outline = "4px solid yellow";
                setTimeout(() => b.style.outline = "", 200);
            }
        }
    });
</script>





{{ endblock }}
